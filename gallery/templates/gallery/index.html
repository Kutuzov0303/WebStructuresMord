
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>3D Storage</title>
    <script type = "importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    {% load static %}
    {% load gallery_extras %}
    <link rel="stylesheet" href="{% static 'gallery/style.css' %}">
</head>
<body>

    <!-- –ë–ª–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
     {% if messages %}
     <div class = "message-container">
        {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
     </div>
    {% endif %}

    <header>
        <h1>{{ page_title }}</h1>
        <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Ç–µ–ø–µ—Ä—å –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ -->
        <a href="{% url 'upload' %}" class="btn" style="background-color: #28a745;">+–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</a>
    </header>

    <!-- –ë–ª–æ–∫ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
     <div class="toolbar">
        <form action="{% url 'home' %}" method="get" style="display: flex; width: 100%; gap: 10px; align-items: center;">
            {# —Å–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç, —á—Ç–æ–±—ã –ø–∞—Ä–∞–º–µ—Ç—Ä days –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è –ø—Ä–∏ –ø–æ–∏—Å–∫–µ/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ #}
            {% if request.GET.days %}
                <input type="hidden" name="days" value="{{ request.GET.days }}">
            {% endif %}

            <input type='text' name = 'q' class="search-input"
                   placeholder="–ü–æ–∏—Å–∫ 3D –º–æ–µ–¥–µ–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." 
                   value="{{ request.GET.q|default:'' }}">

            <select name = "ordering" class = "sort-select" onchange="this.form.submit()">
                <option value="new" {% if request.GET.ordering == 'new' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                <option value="old" {% if request.GET.ordering == 'old' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                <option value="name" {% if request.GET.ordering == 'name' %}selected{% endif %}>–ü–æ –∏–º–µ–Ω–∏ (–ê-–Ø)</option>
            </select>

            <button type="submit" class="search-btn">–ù–∞–π—Ç–∏</button>

            {% if request.GET.q or request.GET.ordering or request.GET.days %}
               <a href="{% url 'home' %}" class="reset-link">‚úñ –°–±—Ä–æ—Å–∏—Ç—å</a>
            {% endif %}

            {# —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –¥–∞—Ç–µ #}
            <div style="margin-left: 20px;">
                {% if request.GET.days == '1' %}
                    {# —É–∂–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä ‚Äì –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–±—Ä–æ—Å #}
                    <a href="{% url 'home' %}?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.ordering %}ordering={{ request.GET.ordering }}&{% endif %}" class="reset-link">‚úñ –°–Ω—è—Ç—å —Ñ–∏–ª—å—Ç—Ä –¥–∞—Ç—ã</a>
                {% else %}
                    <a href="{% url 'home' %}?days=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}" class="filter-link">–¢–æ–ª—å–∫–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</a>
                {% endif %}
            </div>

        </form>
    </div>

    <main>
        <div class="gallery-grid">
            {% for asset in page_obj %}
               <div class="asset-card">
                <!-- 1.–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ü—Ä–µ–≤—å—é (–í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å) -->
                   <div class="card-preview js-load-3d"
                        id="model-container-{{ asset.id }}"
                        data-url="{{ asset.file.url }}"
                        {% if asset.image %}
                            style="background-image: url('{{ asset.image.url }}');"
                            data-thumb="{{ asset.image.url }}"
                        {% endif %}
                        >

                        {% if asset.image %}
                            <!-- Play button will be drawn with CSS (pseudo-element) -->
                            <div class="play-btn">‚ñ∂</div>
                        {% else %}
                            <span style="font-size: 2rem;">üé≤</span>
                        {% endif %}
                   </div>
                <!-- 2. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å) -->
                 <div class="card-info">
                    <h3 class="card-title">{{ asset.title }}</h3>

                    <div class="card-meta">
                        <span>üìÖ {{ asset.created_at|date:"d M Y" }}</span>
                        {% if asset.file %}
                            <span style="float: right;">üíæ {{ asset.file.size|filesizeformat }}</span>
                        {% endif %}
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
                    {% if asset.file %}
                        <a href="{{ asset.file.url }}" class="btn" style="background-color: #007bff; margin-top: 10px;">–°–∫–∞—á–∞—Ç—å</a>
                    {% else %}
                        span style="color: red;">–§–∞–π–ª –ø–æ—Ç–µ—Ä—è–Ω</span>
                    {% endif %}
                 </div>
               </div>
               {% empty %}
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        {% if request.GET.q %}
                            <h3>–ü–æ –∑–∞–ø—Ä–æ—Å—É "<b>{{ request.GET.q }}</b>" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üïµÔ∏è</h3>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ <a href = "{% url 'home' %}">—Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a></p>
                        {% else %}
                            <h3>–ë–∞–∑–∞ –ø—É—Å—Ç–∞</h3>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å!</p>
                        {% endif %}
                    </div>
                <p>–ë–∞–∑–∞ –ø—É—Å—Ç–∞</p>
                {% endfor %}
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
         <div class="pagination">
            <span class="step-links">
                {% if page_obj.has_previous %}
                    <a href="?{% param_replace request page=1 %}">&laquo; –ü–µ—Ä–≤–∞—è</a>
                    <a href="?{% param_replace request page=page_obj.previous_page_number %}">–ù–∞–∑–∞–¥</a>"
                {% endif %}

                <span class="current">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?{% param_replace request page=page_obj.next_page_number %}">–î–∞–ª–µ–µ</a>
                    <a href="?{% param_replace request page=page_obj.paginator.num_pages%}">–ü–æ—Å–ª–µ–¥–Ω—è—è &raquo;</a>
                {% endif %}
            </span>

         </div>

    </main>

    <footer>
        <p>&copy; 2026 Web Structures Course</p>
    </footer>
    <script type="module">
        //–ò–º–ø–æ—Ä—Ç
        import { loadModel } from "{% static 'gallery/js/viewer.js' %}";

        const containers = document.querySelectorAll('.js-load-3d');

        containers.forEach(container => {

            // –∑–∞–ø–æ–º–Ω–∏–º –Ω–∞—á–∞–ª—å–Ω—ã–π HTML (—Ñ–æ–Ω –∏ –∫–Ω–æ–ø–∫–∞) –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            if (!container.dataset.originalHtml) {
                container.dataset.originalHtml = container.innerHTML;
            }

            container.addEventListener('click', function(){

                if(this.querySelector('canvas')) return; // –ï—Å–ª–∏ Canvas —É–∂–µ –µ—Å—Ç—å

                this.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Canvas

            const id = this.id;
            const url = this.dataset.url;

            if (url) {
                console.log("–ó–∞–≥—Ä—É–∂–∞—é 3D –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é:", url);
                loadModel(id, url);
            }
            });
        });
    </script>
</body>